<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../elements/elements.html">
<link rel="import" href="../shared-styles.html">
<link rel="import" href="../webgazer-wrapper.html">
<link rel="import" href="../webgazer-wrapper.html">
<dom-module id="story-blocks-tracking">
  <template>
    <style include="shared-styles">
    </style>

  </template>
  <script>
    Polymer({
        is: 'story-blocks-tracking',
        properties: {},
        attached () {
            webgazer.addRegressionModule("stable", webgazer.reg.StableReg);
            webgazer.setRegression('stable') /* currently must set regression and tracker */
                .setTracker('clmtrackr')
                .setGazeListener(function (data, clock) {
                       //console.log(data); /* data is an object containing an x and y key which are the x and y prediction coordinates (no bounds limiting) */
                       //console.log(clock); /* elapsed time in milliseconds since webgazer.begin() was called */
                })
                .begin()
                .showPredictionPoints(true); /* shows a square every 100 milliseconds where current prediction is */

            this.width = 320;
            this.height = 240;
            this.topDist = '0px';
            this.leftDist = '0px';

            setTimeout(() => {
                this.checkIfReady();
            }, 100);
        },
        drawLoop() {
            if (this.drawLoop) {
                requestAnimFrame(this.drawLoop);
                this.overlay.getContext('2d').clearRect(0, 0, this.width, this.height);
                if (this.cl.getCurrentPosition()) {
                    this.cl.draw(this.overlay);
                }
            }
        },
        setup () {
            var video = document.getElementById('webgazerVideoFeed');

            video.style.display = 'block';
            video.style.position = 'absolute';
            video.style.top = this.topDist;
            video.style.left = this.leftDist;
            video.width = this.width;
            video.height = this.height;
            video.style.margin = '0px';

            webgazer.params.imgWidth = this.width;
            webgazer.params.imgHeight = this.height;

            var overlay = this.overlay = document.createElement('canvas');
            overlay.id = 'overlay';
            overlay.style.position = 'absolute';
            overlay.width = this.width;
            overlay.height = this.height;
            overlay.style.top = this.topDist;
            overlay.style.left = this.leftDist;
            overlay.style.margin = '0px';

            document.body.appendChild(overlay);

            this.cl = webgazer.getTracker().clm;

            this.drawLoop();
        },
        checkIfReady () {
            if (webgazer.isReady()) {
                this.setup();
            } else {
                setTimeout(this.checkIfReady.bind(this), 100);
            }


        }
    });
  </script>
</dom-module>
